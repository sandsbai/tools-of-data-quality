# 数据质量之真数不怕火炼
>
>Talk is cheap, show me the data.

数据质量关乎数据产品的成败，这个事实似乎已不用强调。但是很多人并不清楚数据质量（DQ）的具体定义，似乎了解了数据质量的大概印象，却在如何识别数据质量问题和如何提升数据质量上束手无策。   

实际上，数据质量并没有一个绝对的、放之四海而皆准的数值标准，需要同时考虑客户需求和投入预算等因素。在这里，**数据质量的定义为：在满足用户需求上对数据完整性、准确性、一致性、易用性和实时性的最低要求。** 其中又以数据准确性方面问题最为常见和严峻，下面将以Data Warehouse建设过程中常见的问题和应对手段进行描述和讨论。

## 1.Data Warehouse建设过程中常见的数据准确性问题

有原始错误的源数据表、描述不清的数据需求文档、有有缺陷的ETL代码、粗心的开发者都是数据准确性问题的源头。小到字段名错误，大到数据逻辑错都是数据准确性的具体反映，下面详细列举一些常见的数据准确性问题，方便沉淀经验和后期的问题筛选。   

可将常见问题氛围结构和数据两类。   

### 1.1.结构错误   
#### 1.1.1.表字段拼写和描述错误
表字段和描述内容是数据用户了解数据信息的重要入口，错误的拼写错误和描述错误，不仅会让用户误用数据，甚至还会让用户对数据的准确性和权威性存疑。  

#### 1.1.2.表字段类型错误
表的用户可能是下一级ETL开发者，也可能是BI开发者，错误的表字段类型错误同样会影响下游使用。譬如int32类型被错误标记为float64，那么会出现筛选范围限制过大或过小的情况。

### 1.2.列数据错误
有时候仅对表结构信息进行验证是不够的。ETL代码的错误，会导致数据的错误合成和转换，反映在数据上就是出现异常的空值、唯一值和范围错误等。此处之所以写**列数据错误**，而不用**数据错误**等其他范围更广的概念，是因为跨列的数据错误形成原因更复杂且解决方案更复杂，留待后面再继续介绍。但是，仅对数据内容进行表字段类型和列数据错误的识别和纠正，就已经能纠正数据开发工作中的大部分问题，因此也是有现实价值的。     

#### 1.2.1.空值错误   
所谓的空值错误，就是依据设计初衷，某字段不可能出现空值的情况。如主键字段、房屋带看时间字段或者经纪人所在门店编码等。这些字段一旦出现空值，则需要进行预警和讨论。当然，在业务系统侧由于人工误操作等原因，可能会出现少量行出现字段为空的情况，但具体问题应具体分析，出现空值预警尽是为了提醒DPM或者开发者注意，避免其他重大问题。  

空值错误的衡量指标可为空值数(na_count)和空值率(na_ratio)，其中控制率为该列数据中值为空、文本null或者其他可表示为空值的符号的总数量，而空值率（na_ratio）=na_count/total_count。
 
#### 1.2.2.唯一值错误   
所谓唯一值错误，就是某字段或者组合字段作为主键，每个值必然是唯一的。同时唯一值错误还可拓展为占比异常错误，例如某类房产业务中，A品牌和B品牌的占比一直为3:2左右，某天突然变动为2:3，必然是由于业务变动或者其他原因导致的。

唯一值错误的衡量指标为唯一值数量（unique_count）和唯一值占比(unique_ratio), 其中唯一值数量为所有列值的去重集合的数量，而唯一值占比（unique_ratio）=unique_count/totol_count。

#### 1.2.3.范围错误
所谓范围值错误，就是列值超出了正常的列值范围。例如表示岁数的列出现了200岁的异常例子，又或者房屋带看日期出现了2025-01-01年的情况，这些都是违反常识的。当然针对不同的数据类型，范围类型可分为不同情况，具体如下：
* 日期类型范围   
如果字段为日期类型，则日期的类型范围为（最早的日期，最晚的日期），凡超出了该时间范围的都是离群点。

* 数值类型范围
如果字段为数值类型，如int64或者float64等，则数值的范围为（最小的数值，最大的数值），凡超出了该数值范围的都是离群点。

* 字符类型范围
如果字段为字符类型，则字符的范围为（字符的最小长度，字符的最大长度），凡超出了该字符长度范围的都是离群点。

* 枚举类型范围
枚举值范围同时对日期、数值和字符类型的字段都有效，只要这些字段的取值范围是预定义且有限的。例如，经纪人的品牌类型就是有限的，凡突然出现了新的品牌枚举值，就需要从业务变动或者ETL错误方面去分析原因。   

## 2.

* 确定数据探查的目的
盲目进行数据探查既没有乐趣，也没有意义，更不会获得技能的增长。通过明确数据探查的目的，可以更好的确定数据探查范围、探查项、相关工具和输出一份实用的总结报告。

目前较为常见的目的有数据质量评估和数据物理建模两类。前者是为了了解数据，后者则是为了满足工程需求。一般来说，后者在实践更有深度，但是为了追求效率往往只涉及若干常用的探查项，因此在探查广度上，比前者要弱。

    * 元数据文件归档
有相当比例的数据库没有说明文档，没有元数据文件，员工交接工作流于形式，导致后续“接班”人员在黑暗之中前行。通过数据探查，可从数据中提取出最真实的数据库元数据信息，并归档管理。
    * 物理建模 
为满足BI需求，DRD需要根据需求分析结果进行物理维度建模。但是在具体开展建模工作前，还需通过数据探查工作来确认数据源是否能满足BI分析需求。
    * 数据质量评估 /数据异常监测
数据质量评估之前先得确定数据质量的标准，此处的内容准备用另外一篇文章来描述。
在明确数据质量后，可对数据质量情况进行监测，并对识别的数据异常情况进行预警，如格式错误预警，空值比例预警或者幅度变动预警等。

* 数据探查范围
在进行数据探查前首先需要确定数据探查的范围，即表文件列表和探查项。探查项和目的有很大相关性。

像贝壳这种级别的公司，月均PB级的数据，数十万级别的ETL任务，数百类主题的Hive表，探查工作究竟要从哪儿搞起？搞哪些文件列表和探查项？一切以需求为准！

数据探查范围包括需求中描述的高优事实和维度数据所在的数据源，同时还包括跨主题分析中的一致性维度所在的其他数据源。

某类特定需求往往会限定主题或者某张Hive表，通过数据血缘分析可以确定其所有上游Hive表。如果我们的目的是进行数据质量评估，则往往需要对

* 待探查数据收集
在进行数据探查前，首先需要尽可能收集可用于探查的数据信息。数据来源可以是内部数据查询入口、交接材料内容的同事和数据仓库等。一切可反应数据库表信息的文档、ETL代码、数据库文件或者flat文件等都是重要的数据探查标的物。当然，在此过程中需尽可能剔除过期、失效甚至错误的信息内容。

* 探查方法
    * 数据分析
    * 业务分析

    * 表结构分析（定性分析）
表结构的分析目的，是为了了解度量和维度组成情况。
    * 数据内容分析（量化分析）
数据内容分析是基于数据对数据库表的结构和内容质量进行分析评估的重要手段，能够实事求是地判定该数据是否能满足业务需求。譬如某BI需求要求某筛选字段值的输入范围为0-10,000，那么通过对该字段值内容进行值范围分析，便可确认该字段是否能满足要求，或者原BI需求是否需要调整。

空值、唯一值和值范围是较为常用和重要的探查项，能较好地解答关于列稀疏性、是否可担当主键、默认值和取值范围等问题。

        * 空值分析
        * 唯一值分析
        * 值范围分析
对于数值型字段，可对其最大值、最小值和平均值进行统计分析；对于字符串字段，可对其最大、最小字符串长度进行统计，或者是对其枚举值范围进行分析；对于日期型字段，则可对其日期的最小值、最大值以及日期格式等进行统计分析。
    * 代码分析

* 总结报告
总结报告主要是对数据探查结果进行总结，方便归档。具体的总结报告内容和最初的探查目的有关，但大致的探查内容都包括探查目的、探查的数据来源和版本、探查项与结果，以及探查结论等等。其中探查结论分为定量和定性两部分，定量是根据数据质量标准或者数据需求来进行的判定，而定性分析则是依赖探查人员的经验以及认知对数据可用性的高度概括。

* 自动化探查
- [ ]
